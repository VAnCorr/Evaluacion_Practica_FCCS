<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Rúbrica - Evaluación Práctica (Paciente Grave)</title>
    <style>
        :root {
            --primary: #0f766e;
            --primary-600: #0d5f59;
            --bg: #f6f8fb;
            --card: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --danger: #dc2626;
            --warn: #d97706;
            --ok: #16a34a;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px;
        }
        header.header {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 16px;
        }
        header.header h1 {
            margin: 0 0 6px;
            font-size: 1.6rem;
        }
        header.header p { margin: 0; color: var(--muted); }
        .badge {
            display: inline-block;
            padding: 6px 10px;
            background: #e0f2f1;
            color: var(--primary-600);
            border-radius: 999px;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        form#evaluacionForm {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        section { margin-bottom: 18px; }
        .section-title { margin: 0 0 10px; font-size: 1.1rem; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        label { font-size: 0.9rem; color: var(--muted); display: block; margin-bottom: 4px; }
        input[type="text"], input[type="date"], textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
            font-size: 0.95rem;
        }
        input[readonly] { background: #f3f4f6; color: #4b5563; }
        fieldset.domain {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }
        fieldset.domain legend {
            padding: 0 8px;
            font-weight: 600;
        }
        .domain-meta {
            display: flex; gap: 10px; align-items: center; color: var(--muted); font-size: 0.9rem; margin-bottom: 8px;
        }
        .criterio { border-top: 1px dashed var(--border); padding-top: 10px; margin-top: 10px; }
        .criterio:first-of-type { border-top: none; margin-top: 0; padding-top: 0; }
        .criterio-header { display: flex; justify-content: space-between; gap: 8px; align-items: baseline; }
        .criterio-title { font-weight: 600; }
        .criterio-weight { color: var(--muted); font-size: 0.85rem; }
        .niveles { display: grid; grid-template-columns: repeat(4, minmax(120px,1fr)); gap: 8px; margin-top: 8px; }
        .nivel {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            background: #fafafa;
        }
        .nivel input { margin-right: 6px; }
        .nivel small { display: block; color: var(--muted); margin-top: 4px; }
        .obs { margin-top: 8px; }
        .domain-summary { margin-top: 8px; color: var(--muted); font-size: 0.92rem; }

        .resumen {
            display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; margin-top: 8px;
            border-top: 1px solid var(--border); padding-top: 12px;
        }
        .pill { padding: 6px 10px; border-radius: 999px; color: #fff; font-weight: 600; font-size: 0.9rem; }
        .pill.insuficiente { background: var(--danger); }
        .pill.suficiente { background: var(--warn); }
        .pill.bueno { background: #0284c7; }
        .pill.excelente { background: var(--ok); }
        .btns { display: flex; flex-wrap: wrap; gap: 8px; }
        button, .btn {
            border: none; cursor: pointer; border-radius: 8px; padding: 10px 14px; font-size: 0.95rem; font-weight: 600;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-600); }
        .btn-secondary { background: #e5e7eb; color: #111827; }
        .footer { color: var(--muted); font-size: 0.85rem; margin-top: 12px; text-align: center; }

        /* Modo impresión */
        @media print {
            .btns, input, textarea, .nivel input { display: none !important; }
            body { background: #fff; }
            header.header, form#evaluacionForm { box-shadow: none; }
            .nivel { border: none; background: none; padding: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Rúbrica de Evaluación Práctica</h1>
            <p>Curso: Reconocimiento y abordaje inicial del paciente grave</p>
            <span class="badge" id="actividadBadge">Actividad: Evaluacion Practica Curso Reconocimiento del paciente Grave</span>
        </header>

        <form id="evaluacionForm" novalidate>
            <section>
                <h2 class="section-title">Información general</h2>
                <div class="form-grid">
                    <div>
                        <label for="nombreResidente">Nombre del residente</label>
                        <input type="text" id="nombreResidente" name="residente" placeholder="Ej.: Juan Pérez" required />
                    </div>
                    <div>
                        <label for="tutorEvaluador">Tutor evaluador</label>
                        <input type="text" id="tutorEvaluador" name="evaluador" placeholder="Ej.: Dra. Ana López" required />
                    </div>
                    <div>
                        <label for="fechaEvaluacion">Fecha</label>
                        <input type="date" id="fechaEvaluacion" name="fecha" required />
                    </div>
                    <div>
                        <label for="actividadEvaluada">Actividad</label>
                        <input type="text" id="actividadEvaluada" name="actividad" value="Evaluacion Practica Curso Reconocimiento del paciente Grave" readonly />
                    </div>
                </div>
            </section>

            <section id="dominiosSection">
                <!-- Dominios/criterios generados dinámicamente -->
            </section>

            <section class="resumen">
                <div>
                    <strong>Puntuación total:</strong> <span id="puntuacionTotal">0.0</span>/100
                    <span id="nivelDesempeno" class="pill insuficiente" aria-live="polite">Sin evaluar</span>
                </div>
                <div class="btns">
                    <button type="button" class="btn-secondary" id="btnReiniciar">Reiniciar</button>
                    <button type="button" class="btn-secondary" id="btnGuardarJson">Guardar evaluación (JSON)</button>
                    <!-- BOTÓN MODIFICADO -->
                    <button type="button" class="btn-primary" id="btnDescargarPdf">Descargar PDF</button>
                    <button type="button" class="btn-primary" id="btnEnviarSheet" title="Enviar registro a Google Sheets">Enviar a Google Sheets</button>
                </div>
            </section>
        </form>

        <p id="statusMsg" class="footer" aria-live="polite"></p>
        <p class="footer">Tip: el nombre del tutor evaluador se recuerda en este navegador para facilitar futuras evaluaciones.</p>
    </div>

    <!-- Librería para generar PDF en el navegador -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <script>
        // ————— Integración con Google Apps Script / Google Sheets —————
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwlIjsIOUuS4qrLzKva-VoywVAkFfy_kBjT8uMHSu-ZAN3BOf9l5ErXKGhTT8_JA9Vm/exec';
        const SHEET_NAME = 'Evaluacion Practica';
        const DRIVE_FOLDER_ID = '108_uU-LrlZdrNcBGZ4GKUsk1Nzjt7_Sj'; // ¡Asegúrate de que este ID sea el correcto!

        // Evitar caché del endpoint (y de proxies intermedios)
        function getEndpoint() {
            const sep = APPS_SCRIPT_URL.includes('?') ? '&' : '?';
            return APPS_SCRIPT_URL + sep + 'v=' + Date.now();
        }

        // Configuración de niveles y factores de puntuación
        const NIVELES = [
            { key: 'insuficiente', label: 'Insuficiente', factor: 0.50, desc: 'Omite pasos críticos o errores de seguridad.' },
            { key: 'suficiente', label: 'Suficiente', factor: 0.70, desc: 'Cumple lo básico con algunas omisiones menores.' },
            { key: 'bueno', label: 'Bueno', factor: 0.85, desc: 'Desempeño sólido con leves oportunidades de mejora.' },
            { key: 'excelente', label: 'Excelente', factor: 1.00, desc: 'Ejecución completa, segura y eficiente.' },
        ];

        // Estructura de dominios/criterios con pesos (suma 100)
        const rubricaConfig = {
            dominios: [
                {
                    id: 'eval_inicial', nombre: 'Evaluación inicial', peso: 30,
                    criterios: [
                        { id: 'eval_prim_sec', texto: 'Realiza evaluación primaria/secundaria estructurada (ABC, AMPLE)', peso: 15 },
                        { id: 'eval_inestab', texto: 'Identifica signos de inestabilidad y prioriza acciones', peso: 15 },
                    ]
                },
                {
                    id: 'procedimientos', nombre: 'Procedimientos', peso: 25,
                    criterios: [
                        { id: 'proc_acceso_vasc', texto: 'Realiza acceso vascular seguro', peso: 12.5 },
                        { id: 'proc_via_aerea', texto: 'Manejo básico de vía aérea', peso: 12.5 },
                    ]
                },
                {
                    id: 'comunicacion', nombre: 'Comunicación', peso: 20,
                    criterios: [
                        { id: 'comu_plan_fam', texto: 'Comunica plan de manejo a familiares', peso: 10 },
                        { id: 'comu_sbar', texto: 'Comunicación clínica estructurada (SBAR) al equipo', peso: 10 },
                    ]
                },
                {
                    id: 'gestion_seg', nombre: 'Gestión/Seguridad', peso: 15,
                    criterios: [
                        { id: 'gest_control_inf', texto: 'Aplica medidas de control de infecciones', peso: 7.5 },
                        { id: 'gest_meds_seg', texto: 'Uso seguro de medicamentos y verificación', peso: 7.5 },
                    ]
                },
                {
                    id: 'prof_etica', nombre: 'Profesionalismo/Ética', peso: 10,
                    criterios: [
                        { id: 'prof_empatia', texto: 'Demuestra empatía y respeto', peso: 5 },
                        { id: 'prof_confid', texto: 'Respeta confidencialidad y principios éticos', peso: 5 },
                    ]
                },
            ]
        };

        const form = document.getElementById('evaluacionForm');
        const dominiosSection = document.getElementById('dominiosSection');
        const totalSpan = document.getElementById('puntuacionTotal');
        const nivelPill = document.getElementById('nivelDesempeno');
        const actividadInput = document.getElementById('actividadEvaluada');
        const fechaInput = document.getElementById('fechaEvaluacion');
        const tutorInput = document.getElementById('tutorEvaluador');
        const statusMsg = document.getElementById('statusMsg');

        function setToday() {
            const tzOffsetMS = (new Date()).getTimezoneOffset() * 60000;
            const todayLocal = (new Date(Date.now() - tzOffsetMS)).toISOString().split('T')[0];
            fechaInput.value = todayLocal;
        }

        function loadTutor() {
            const stored = localStorage.getItem('rubrica_tutor');
            if (stored) tutorInput.value = stored;
        }
        function saveTutor() {
            if (tutorInput.value.trim()) {
                localStorage.setItem('rubrica_tutor', tutorInput.value.trim());
            }
        }

        function renderRubrica() {
            dominiosSection.innerHTML = '';
            rubricaConfig.dominios.forEach((dom) => {
                const fs = document.createElement('fieldset');
                fs.className = 'domain';
                fs.id = `dom-${dom.id}`;
                const legend = document.createElement('legend');
                legend.textContent = `${dom.nombre}`;
                fs.appendChild(legend);
                const meta = document.createElement('div');
                meta.className = 'domain-meta';
                meta.innerHTML = `<span>Peso del dominio: <strong>${dom.peso}%</strong></span>`;
                fs.appendChild(meta);
                dom.criterios.forEach((crit) => {
                    const wrap = document.createElement('div');
                    wrap.className = 'criterio';
                    const head = document.createElement('div');
                    head.className = 'criterio-header';
                    head.innerHTML = `<div class="criterio-title">${crit.texto}</div><div class="criterio-weight">Peso: ${crit.peso}%</div>`;
                    wrap.appendChild(head);
                    const nivelesGrid = document.createElement('div');
                    nivelesGrid.className = 'niveles';
                    NIVELES.forEach((n, idx) => {
                        const label = document.createElement('label');
                        label.className = 'nivel';
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = `nivel_${dom.id}_${crit.id}`;
                        input.value = n.key;
                        input.setAttribute('data-factor', n.factor);
                        input.addEventListener('change', calcularTotales);
                        label.appendChild(input);
                        const span = document.createElement('span');
                        span.innerHTML = `<strong>${n.label}</strong>`;
                        label.appendChild(span);
                        const small = document.createElement('small');
                        small.textContent = n.desc;
                        label.appendChild(small);
                        nivelesGrid.appendChild(label);
                    });
                    wrap.appendChild(nivelesGrid);
                    const obs = document.createElement('div');
                    obs.className = 'obs';
                    const obsLabel = document.createElement('label');
                    obsLabel.textContent = 'Observaciones cualitativas';
                    const obsTa = document.createElement('textarea');
                    obsTa.rows = 2;
                    obsTa.id = `obs_${dom.id}_${crit.id}`;
                    obs.appendChild(obsLabel);
                    obs.appendChild(obsTa);
                    wrap.appendChild(obs);
                    fs.appendChild(wrap);
                });
                const sum = document.createElement('div');
                sum.className = 'domain-summary';
                sum.id = `sum-${dom.id}`;
                sum.textContent = 'Puntuación dominio: 0.0/' + dom.peso;
                fs.appendChild(sum);
                dominiosSection.appendChild(fs);
            });
        }

        function calcularTotales() {
            let total = 0;
            rubricaConfig.dominios.forEach((dom) => {
                let domTotal = 0;
                dom.criterios.forEach((crit) => {
                    const sel = document.querySelector(`input[name="nivel_${dom.id}_${crit.id}"]:checked`);
                    if (sel) {
                        const factor = parseFloat(sel.getAttribute('data-factor')) || 0;
                        domTotal += crit.peso * factor;
                    }
                });
                if (domTotal > dom.peso) domTotal = dom.peso;
                total += domTotal;
                const sum = document.getElementById(`sum-${dom.id}`);
                if (sum) sum.textContent = `Puntuación dominio: ${domTotal.toFixed(1)}/${dom.peso}`;
            });
            totalSpan.textContent = total.toFixed(1);
            const nivel = nivelGlobal(total);
            nivelPill.textContent = nivel.rotulo;
            nivelPill.className = `pill ${nivel.clase}`;
        }

        function nivelGlobal(total) {
            if (total >= 91) return { rotulo: 'Excelente', clase: 'excelente' };
            if (total >= 76) return { rotulo: 'Bueno', clase: 'bueno' };
            if (total >= 51) return { rotulo: 'Suficiente', clase: 'suficiente' };
            return { rotulo: 'Insuficiente', clase: 'insuficiente' };
        }

        function construirSalida() {
            const residente = document.getElementById('nombreResidente').value.trim();
            const tutor = tutorInput.value.trim();
            const fecha = fechaInput.value;
            const actividad = actividadInput.value;
            const resultados = [];
            const criteriosLineales = [];
            rubricaConfig.dominios.forEach((dom) => {
                let domTotal = 0;
                const criterios = dom.criterios.map((crit) => {
                    const sel = document.querySelector(`input[name="nivel_${dom.id}_${crit.id}"]:checked`);
                    const nivel = sel ? sel.value : null;
                    const factor = sel ? parseFloat(sel.getAttribute('data-factor')) : 0;
                    const puntaje = +(crit.peso * factor).toFixed(2);
                    domTotal += puntaje;
                    const obs = document.getElementById(`obs_${dom.id}_${crit.id}`)?.value || '';
                    criteriosLineales.push(puntaje);
                    return { id: crit.id, criterio: crit.texto, nivel, puntaje, peso: crit.peso, observaciones: obs };
                });
                resultados.push({ dominio: dom.nombre, peso: dom.peso, puntaje: +domTotal.toFixed(2), criterios });
            });
            const total = resultados.reduce((acc, d) => acc + d.puntaje, 0);
            const nivel = nivelGlobal(total);
            const ordenados = [...resultados].sort((a,b)=>b.puntaje - a.puntaje);
            const fortalezas = `Destaca en ${ordenados[0]?.dominio || ''}${ordenados[1] ? ` y ${ordenados[1].dominio}` : ''}.`;
            const areas = `Debe reforzar ${ordenados.at(-1)?.dominio || ''}.`;
            return {
                residente: residente || 'N/D', fecha, curso: 'Reconocimiento y abordaje inicial del paciente grave', actividad,
                tutor: tutor || 'N/D', total: +total.toFixed(2), nivel: nivel.rotulo, resultados, criteriosLineales,
                resumen: { fortalezas, areas_mejora: areas },
            };
        }

        function construirPayloadSheet() {
            const out = construirSalida();
            const tzOffsetMS = (new Date()).getTimezoneOffset() * 60000;
            const timestamp = (new Date(Date.now() - tzOffsetMS)).toISOString().replace('T',' ').slice(0,19);
            const maxCols = 14;
            const arr = [...out.criteriosLineales];
            while (arr.length < maxCols) arr.push('');
            const [c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,c14] = arr;
            const obs = out.resultados.flatMap(d => d.criterios).filter(c => (c.observaciones || '').trim().length > 0)
                .map(c => `• ${c.criterio}: ${c.observaciones.trim()}`).join('\n');
            return {
                sheetName: SHEET_NAME, timestamp, nombre_residente: out.residente, tutor_evaluador: out.tutor,
                fecha_evaluacion: out.fecha, actividad_evaluada: out.actividad, c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,c14,
                puntuacion_total: out.total, nivel_desempeno: out.nivel, observaciones: obs,
                criterios_headers: rubricaConfig.dominios.flatMap(d => d.criterios.map(c=>c.id)),
            };
        }

        function postViaForm(url, payloadObj) {
            return new Promise((resolve) => {
                const iframeName = 'gs_iframe_' + Date.now();
                const iframe = document.createElement('iframe');
                iframe.name = iframeName;
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = url;
                form.target = iframeName;
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'payload';
                input.value = JSON.stringify(payloadObj);
                form.appendChild(input);
                document.body.appendChild(form);
                const cleanup = () => { setTimeout(() => { try { form.remove(); iframe.remove(); } catch(_){} resolve(); }, 50); };
                iframe.addEventListener('load', cleanup, { once: true });
                form.submit();
                setTimeout(cleanup, 3500);
            });
        }

        async function enviarAGoogleSheet() {
            const btn = document.getElementById('btnEnviarSheet');
            const payload = construirPayloadSheet();
            statusMsg.textContent = 'Enviando a Google Sheets…';
            btn.disabled = true;
            try {
                await fetch(getEndpoint(), {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload),
                });
                statusMsg.textContent = 'Registro enviado (respuesta no legible por CORS). Verifica en la hoja.';
            } catch (err) {
                console.error(err);
                try {
                    await postViaForm(getEndpoint(), payload);
                    statusMsg.textContent = 'Registro enviado mediante fallback (form). Verifica en la hoja.';
                } catch (err2) {
                    console.error(err2);
                    statusMsg.textContent = 'No se pudo enviar a Google Sheets. Revisa la publicación del Web App (CORS/permiso).';
                }
            } finally {
                btn.disabled = false;
                saveTutor();
            }
        }

        async function generarYSubirPDF() {
            const btn = document.getElementById('btnPdfDrive');
            btn.disabled = true;
            statusMsg.textContent = 'Generando PDF…';
            const out = construirSalida();
            const safeName = (out.residente || 'Residente').replace(/[^A-Za-z0-9_\- ]/g,'_');
            const fecha = document.getElementById('fechaEvaluacion').value || 'fecha';
            const fileName = `Informe_Evaluacion_Practica_${safeName}_${fecha}.pdf`;
            const element = document.querySelector('.container');
            const opt = {
                margin: [10,10,10,10], filename: fileName, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            let payload;
            try {
                const dataUri = await html2pdf().set(opt).from(element).toPdf().output('datauristring');
                const base64 = dataUri.split(',')[1];
                statusMsg.textContent = 'Subiendo PDF a Google Drive…';
                payload = construirPayloadSheet();
                payload.pdf_base64 = base64;
                payload.pdf_filename = fileName;
                payload.folder_id = DRIVE_FOLDER_ID;
                await fetch(getEndpoint(), {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload),
                });
                statusMsg.textContent = 'PDF enviado a Drive y registro solicitado. Verifica en Drive y la hoja.';
            } catch (err) {
                console.error("Error en el intento principal de subir PDF:", err);
                statusMsg.textContent = 'El intento principal falló. Probando con método alternativo...';
                try {
                    if (!payload) { payload = construirPayloadSheet(); }
                    await postViaForm(getEndpoint(), payload);
                    statusMsg.textContent = 'PDF enviado mediante fallback (form). Verifica en Drive y en la hoja.';
                } catch (err2) {
                    console.error("Error en el fallback de subir PDF:", err2);
                    statusMsg.textContent = 'Error generando o subiendo el PDF. Revisa la consola.';
                }
            } finally {
                btn.disabled = false;
                saveTutor();
            }
        }

        function descargarJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // --- NUEVA FUNCIÓN PARA DESCARGAR PDF DIRECTAMENTE ---
        async function descargarPDF() {
            const btn = document.getElementById('btnDescargarPdf');
            btn.disabled = true;
            statusMsg.textContent = 'Generando PDF para descarga...';

            try {
                const out = construirSalida();
                const safeName = (out.residente || 'Residente').replace(/[^A-Za-z0-9_\- ]/g, '_');
                const fecha = document.getElementById('fechaEvaluacion').value || 'fecha';
                const fileName = `Evaluacion_Practica_${safeName}_${fecha}.pdf`;

                const element = document.querySelector('.container');
                const opt = {
                    margin:       [10, 10, 10, 10],
                    filename:     fileName,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Esta línea genera el PDF y lo descarga automáticamente
                await html2pdf().set(opt).from(element).save();
                
                statusMsg.textContent = 'PDF generado. La descarga debería comenzar en breve.';
            } catch (err) {
                console.error('Error al generar el PDF:', err);
                statusMsg.textContent = 'Ocurrió un error al generar el PDF. Revisa la consola.';
            } finally {
                btn.disabled = false; // Vuelve a habilitar el botón
            }
        }

        // --- EVENTOS UI (SECCIÓN MODIFICADA) ---
        document.getElementById('btnDescargarPdf').addEventListener('click', descargarPDF); // Modificado

        document.getElementById('btnGuardarJson').addEventListener('click', () => {
            const out = construirSalida();
            const safeName = (out.residente || 'Residente').replace(/[^A-Za-z0-9_\- ]/g,'_');
            const fecha = document.getElementById('fechaEvaluacion').value || 'fecha';
            descargarJSON(out, `Evaluacion_Practica_${safeName}_${fecha}.json`);
            saveTutor();
        });
        document.getElementById('btnReiniciar').addEventListener('click', () => {
            if (confirm('¿Limpiar selección y observaciones?')) {
                form.reset();
                setToday();
                calcularTotales();
                loadTutor();
            }
        });
        document.getElementById('btnEnviarSheet').addEventListener('click', enviarAGoogleSheet);
        
        (function ensurePdfBtn(){
            if (!document.getElementById('btnPdfDrive')) {
                const btns = document.querySelector('.btns');
                const b = document.createElement('button');
                b.type = 'button'; b.id = 'btnPdfDrive'; b.className = 'btn-primary';
                b.textContent = 'Generar PDF y subir a Drive';
                b.title = 'Genera un PDF y lo envía a la carpeta de Drive designada';
                btns.appendChild(b);
            }
            document.getElementById('btnPdfDrive').addEventListener('click', generarYSubirPDF);
        })();

        // Inicialización
        (function init(){
            setToday();
            loadTutor();
            renderRubrica();
            calcularTotales();
        })();
    </script>
</body>
</html>
